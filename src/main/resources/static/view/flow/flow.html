<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据融合流程</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <link rel="stylesheet" href="/admin/css/font.css">
    <link rel="stylesheet" href="/admin/css/xadmin.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/javascripts/ajaxUtil.js"></script>
    <script type="text/javascript" src="/admin/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/admin/js/xadmin.js"></script>
    <link rel="stylesheet" href="/css/jquery.json-viewer.css">
    <script src="/js/jquery.json-viewer.js"></script>
    <link rel="stylesheet" href="/admin/lib/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/admin/layui_ext/dtree/dtree.css">
    <!--<script type="text/javascript" src="/admin/layui_ext/dtree/dtree.js"></script>-->
    <link rel="stylesheet" href="/admin/layui_ext/dtree/font/dtreefont.css">
    <link rel="stylesheet" href="/css/flow.css">
    <!--<script type="text/javascript" src="../../js/SuperSlide2.1/jquery1.42.min.js"></script>-->
    <script type="text/javascript" src="../../js/SuperSlide2.1/jquery.SuperSlide.2.1.3.js"></script>
    <link rel="stylesheet" href="./superslide.css">
</head>
<body>
     <div class="container_box">
          <div class="flow1">
               <div class="header">
                   <div class="header_left">
                       Step1:选取融合表
                   </div>
                   <div class="header_right">
                         <span style="visibility: ">previous</span>
                         <span class="next" >next</span>
                   </div>

               </div>
              <div class="main">
                  <div class="main_left">
                      <h3 style="padding-left: 20px;margin: 15px 0;font-size: 19px;">表格目录</h3>
                      <ul style="width: 100%;height: 500px;overflow-y:auto;"  id="demoTree" class="dtree" data-id="0"></ul>
                  </div>
                  <div class="main_right">

                      <div class="picScroll-left">
                          <div class="hd">
                              <span class="prev"><i class="layui-icon layui-icon-right"></i></span>
                              <ul></ul>
                              <span class="next"><i class="layui-icon layui-icon-left"></i></span>
                              <span class="pageState"></span>
                          </div>
                          <div class="bd">
                              <ul id="picList">

                              </ul>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
         <div class="flow2">
              <div class="header">
                 <div class="header_left">
                     Step2:添加主属性组
                 </div>
                 <div class="header_right">
                     <span class="prev" >previous</span>
                     <span class="next" >next</span>
                 </div>

             </div>
             <div class="nature">
                 <div class="nature_left">

                     <div class="picScroll-left">
                         <div class="hd">
                             <span class="prev"><i class="layui-icon layui-icon-right"></i></span>
                             <ul></ul>
                             <span class="next"><i class="layui-icon layui-icon-left"></i></span>
                             <span class="pageState"></span>
                         </div>
                         <div class="bd">
                             <ul id="picList1"></ul>
                         </div>
                     </div>
                 </div>
                 <div class="nature_right">
                      <div class="top">

                          <span class="add">融合存储信息</span>
                      </div>
                     <div class="module">
                         <p>主属性名 <input type="text" id="nature_name" class="nature_name" style="margin-left: 20px;"></p>
                         <p>相似判断符
                             <select name="" id="selectbox" style="margin-left: 8px;width: 178px;">
                                 <option value="EQ">相等</option>
                                 <option value="LLK">左相等</option>
                             </select>
                         </p>
                         <div class="nature_result">
                             <span>选择属性</span>
                             <div class="results"></div>
                         </div>
                         <div class="create">
                             <span class="create-confim">确定</span>
                         </div>
                     </div>

                 </div>
             </div>
         </div>
         <div class="flow3">
             <div class="header">
             <div class="header_left">
                 Step3:生成主属性约束
             </div>
             <div class="header_right">
                 <span class="prev" >previous</span>
                 <span class="next" >next</span>
             </div>

         </div>
             <div class="restrain">
                 <div class="restrain_left">
                      <p><span>主属性组</span></p>
                      <div class="lunbo">
                          <div class="picScroll-left" style="margin-top: 15px;">
                              <div class="hd">
                                  <span class="prev"><i class="layui-icon layui-icon-right"></i></span>
                                  <ul></ul>
                                  <span class="next"><i class="layui-icon layui-icon-left"></i></span>
                                  <span class="pageState"></span>
                              </div>
                              <div class="bd" style="min-height: auto;">
                                  <ul id="picList2"></ul>
                              </div>
                          </div>
                      </div>
                 </div>
                 <div class="restrain_right">
                     <div class="top">
                         <span>编辑主属性约束</span>
                     </div>
                     <div class="menu containers">
                         <div class="operator">
                              <p><span>逻辑组件</span></p>
                             <ul id="operator">
                                 <li>( )</li>
                                 <li>AND</li>
                                 <li>OR</li>
                                 <li>NOT</li>
                             </ul>
                         </div>
                         <div  class="choose">
                             <textarea name="" id="text" cols="30" rows="10" style="width: 90%;height: 80%;margin: 20px;padding: 10px;" placeholder="示例数据:( 名字属性组 AND 年龄属性组 ) OR Id属性组,提醒:操作符前后需要空一格"></textarea>
                         </div>
                     </div>
                     <div class="foot-confim">
                           <span>确定</span>
                     </div>
                 </div>
             </div>
         </div>
         <div class="flow4">
             <div class="header">
                 <div class="header_left">
                     Step4:配置融合存储信息
                 </div>
                 <div class="header_right">
                     <span class="prev" >previous</span>
                     <span class="next" >next</span>
                 </div>

             </div>
             <div class="nature">
                 <div class="nature_left">

                     <div class="picScroll-left" style="margin-top: 15px">
                         <div class="hd">
                             <span class="prev"><i class="layui-icon layui-icon-right"></i></span>
                             <ul></ul>
                             <span class="next"><i class="layui-icon layui-icon-left"></i></span>
                             <span class="pageState"></span>
                         </div>
                         <div class="bd">
                             <ul id="picList3"></ul>
                         </div>
                     </div>
                 </div>
                 <div class="nature_right">

                     <div class="module">
                         <!--<p>表名 <input type="text" id="table_name" class="nature_name" style="margin-left: 20px;"></p>-->
                         <div class="layui-form-item"  >
                             <label for="password" class="layui-form-label" style="width: 30px;padding-left: 0px;">
                                 <span class="x-red">*</span>表名</label>
                             <div class="layui-input-inline">
                                 <input type="text" id="table_name" class="nature_name" style="margin-left: 20px;height: 20px;margin-top: 6px;">
                             </div>

                         </div>
                         <div class="layui-form-item"   >
                             <label for="password" class="layui-form-label" style="width: 53px;padding-left: 0px;">
                                 <span class="x-red">*</span>存储位置</label>
                             <div class="layui-input-inline">
                                 <input type="text" id="browseInput"   required="" autocomplete="off" placeholder="--请选择目录--"
                                        class="layui-input" value="" disabled="disabled"  >
                                 <input type="hidden" id="parentId" name="parentId"   >
                                 <input type="hidden" id="parentName" name="parentName"   >
                             </div>
                             <button id="browse" data-method="offset2" data-type="auto" class="layui-btn">浏览</button>
                         </div>
                         <div class="layui-form-item"   >
                             <label for="password" class="layui-form-label" style="width: 53px;padding-left: 0px;">
                                 <span class="x-red">*</span>选择属性</label>
                         </div>
                         <div class=" table-list">
                             <ul>
                                 <li>名字</li>
                                 <li>类型</li>
                                 <li>长度</li>
                                 <li>备注</li>
                                 <li>选择</li>
                                 <li>主参考</li>
                                 <!--<li>操作</li>-->
                             </ul>
                             <!--<ul class="list">-->
                                 <!--<li class="names"><input type="text" ></li>-->
                                 <!--<li class="types"><input type="text"></li>-->
                                 <!--<li class="lengths"><input type="text"></li>-->
                                 <!--<li class="extarea"><input type="text"></li>-->
                                 <!--<li class="chooses"></li>-->
                                 <!--<li class="mains"></li>-->
                                 <!--<li style="display:flex;justify-content: center;align-content: center;"><span>删除</span></li>-->
                             <!--</ul>-->

                         </div>
                         <div style="display: flex">
                               <span id="addtabellist">添加新行</span>
                              <span id="addchooses">添加选择</span>
                              <span id="addconsults">添加主参考</span>
                         </div>
                         <div class="create">
                             <span class="create-local" id="submitTableInfoBtn">确定</span>

                         </div>
                     </div>
                 </div>
             </div>
         </div>
         <div class="flow5">
             <div class="header">
                 <div class="header_left">
                     Step5:预览融合信息
                 </div>
                 <div class="header_right">
                     <span class="prev" >previous</span>
                     <span class="submit" id="submit">submit</span>
                 </div>

             </div>
             <div class="preview">
                 <div class="preview_left">
                     <p style="padding-left: 20px;font-size: 15px;line-height: 30px;margin-top: 10px;">主属性组信息</p>

                         <div class="picScroll-left" style="margin-top: 15px;">
                             <div class="hd">
                                 <span class="prev"><i class="layui-icon layui-icon-right"></i></span>
                                 <ul></ul>
                                 <span class="next"><i class="layui-icon layui-icon-left"></i></span>
                                 <span class="pageState"></span>
                             </div>
                             <div class="bd" style="min-height: auto;">
                                 <ul id="picList4"></ul>
                             </div>
                         </div>

                 </div>
                 <div class="preview_center">
                     <div class="view-top" style="padding-left: 20px;font-size: 15px;line-height: 30px;margin-top: 10px;">
                         主属性组约束信息
                     </div>
                     <div class="view-content" style="height: 300px;border: 1px solid #ddd;margin: 20px;"></div>
                 </div>
                 <div class="preview_right" >
                       <h2 style="padding-left: 20px;font-size: 15px;line-height: 30px;margin-top: 10px;">融合数据存储信息</h2>
                        <div class="table_info" id="tabledetail"></div>
                 </div>
         </div>


     </div>



     <script type="text/javascript">

         // $(document).ready(function (){

             let MappingList = []
             let maindata = [];//生成主属性要融合的数据
             let leftArr = []
             let selectarr=[]; //选中的数据
             let tablearr = [];//存储需要融合的表格的数据
             function treeDataConversion(data){
                 let cloneData = JSON.parse(JSON.stringify(data))    // 对源数据深度克隆
                 let tree = cloneData.filter((father)=>{              //循环所有项
                     let branchArr = cloneData.filter((child)=>{
                         return father.id == child.parentId      //返回每一项的子级数组
                     });
                 if(branchArr.length>0){
                     father.children = branchArr;    //如果存在子级，则给父级添加一个children属性，并赋值
                 }
                 return father.parentId==0;      //返回第一层
             });
                 return tree     //返回树形数据
             }


             $.ajax({
                 type: "post",
                 async: false,
                 url: "/dataMapping/getDataMappingList",
                 data: '',
                 dataType: 'json',
                 contentType: 'text/plain;charset=UTF-8',
                 success: function (resData) {
                     MappingList = resData.data
                     leftArr = resData.data

                     leftArr.forEach((item,index)=>{
                         item.title = item.name
                    })
                     //leftArr = leftArr.filter((item)=> item.type ==0)

                     // console.log(JSON.stringify(leftArr))
                 },
                 error: function (request) {//请求失败之后的操作
                     layer.alert(data.errMsg, {icon: 2})
                 }
             });
             let newData = treeDataConversion(leftArr)
            // console.log(newData)
             let demoTree = newData
             layui.extend({
                 dtree: '{/}dtree'   // {/}的意思即代表采用自有路径，即不跟随 base 路径
             }).use(['dtree','layer','jquery'], function(){
                 var dtree = layui.dtree, layer = layui.layer, $ = layui.jquery;

                 // 初始化树
                 var DTree = dtree.render({
                     elem: "#demoTree",
                     toolbar:true,
                     data: demoTree, // 使用data加载
                     icon: ["0","7"],
                     ficon: ['1','-1'] , // 隐藏一级图标

                     //scroll:$('#tree'),
                      toolbarShow:[],
                     toolbarExt:[
                         {toolbarId: "add",icon:"dtree-icon-roundadd",title:"添加数据",
                             handler: function(node){
                                  //console.log(node);
                                  var id = node.nodeId;
                                 saveselect(id,1);


                         }},
                         {toolbarId: "del",icon:"dtree-icon-delete1",title:"删除数据",
                             handler: function(node){

                                 var id = node.nodeId;
                                 saveselect(id,2);
                             }
                         }
                         ],

                     toolbarBtn:[
                         [
                          /*   {"label":"下拉框","name":"type","type":"select","optionsData":function(){
                                     return {"0":"文件夹","1":"文件"};
                                 }},*/
                             {"value":"重置","name":"name6","type":"reset"},
                             {"value":"提交","name":"name7","type":"submit","defElem":"btn"},
                         ] // 这就是自定义新增中的内容
                     ]
                 });
             });

             function saveselect(id,num,text){


                 $.ajax({
                     type:'get',
                     data:{id:id},
                     async:false,
                     dataType: 'json',
                     contentType: 'text/plain;charset=UTF-8',
                     url:'/dataMapping/getTableInfoById' ,
                     success:function(res){
                         //console.log(res)
                         let data =[];

                         if(res.code ==200){
                               data =res.data;
                             if(num ==1){
                                  selectarr.push(data);
                                 layer.alert(data.tableName + '添加成功')
                             }else if(num ==2){
                                  var tablename = selectarr.map(item=>{
                                      return item.tableName;
                                  })
                                 if(tablename.indexOf(data.tableName) ==-1){
                                     layer.alert( '请先添加' + data.tableName)
                                 }else{
                                     selectarr = selectarr.filter(item=>{
                                      return item.tableName !== data.tableName;
                                     })
                                    layer.alert(data.tableName + '删除成功')
                                    }
                             }
                             //console.log(selectarr)
                             carousels(selectarr);
                             save(selectarr);
                             showtable(selectarr);
                         }

                           },
                     error: function(){
                         DTree.changeTreeNodeDel(false);// 删除失败
                     }
                 })
             }


             //对添加过来的表格进行模板渲染

             function carousels(val){
                 tablearr = val;
                // console.log(val)
                 val = val.map(item=>{
                    var id = item.realTableName;
                     var name = item.tableName;
                     var data = item.columns;
                      data = data.map(list=>{
                          return `<p style="line-height: 30px;margin: 5px 0;margin-left: 20px;text-align: left;">${list.columnName}:${list.columnType}</p>`
                      })

                    return `<li class="tablelist" style="overflow-y: auto;">
                                <h2 style="text-align: center;line-height: 30px;margin: 10px 0;">${name}:${id}</h2>` + data.join('') + `</li>`
                 })

                 $('#picList').html(val);

                 $(".picScroll-left").slide({titCell:".hd ul",mainCell:".bd ul",autoPage:true,effect:"left",autoPlay:false,vis:3,trigger:"click"});

             }
            //选择融合表的下一页
             $('.next').on('click',function(){

                   $(this).parents('.header').parent().next().show().siblings().hide();
             })
             $('.prev').on('click',function(){
                 $(this).parents('.header').parent().prev().show().siblings().hide();
             })
             //点击下一步保存第一页选取组件的数据
             function save(data){
                 console.log(data)
                  val = data.map(item=>{
                   var id =item.realTableName;
                   var name = item.tableName;
                   var data = item.columns;
                 data = data.map(list=>{
                     return `<div style="line-height: 30px;margin: 5px 0;margin-left: 20px;display: flex;">

                                 <div class="layui-table-cell laytable-cell-1-0-0 laytable-cell-checkbox" style="text-align:left;padding-left: 20px;"><input type="checkbox" name="layTableCheckbox" lay-skin="primary" style="display: none"><div class="layui-unselect layui-form-checkbox user-oper" lay-skin="primary" style="margin-right: 10px;margin-top: 7px;"><i class="layui-icon layui-icon-ok"></i></div></div>
                                 <span class="tablename">${list.columnName}:${list.columnType}</span>
                              </div>`

                 })

                 return `<li class="tablelist" style="overflow-y: auto;"><h2 style="text-align: center;line-height: 30px;margin: 10px 0;">${name}:${id}</h2><p style="display: none;">${id}</p>` + data.join('') + `</li>`
             })

         $('#picList1').html(val);

         $(".picScroll-left").slide({titCell:".hd ul",mainCell:".bd ul",autoPage:true,effect:"left",autoPlay:false,vis:3,trigger:"click"});


             }
              //生成uuid
             function uuid() {
                 var s = [];
                 var hexDigits = "0123456789abcdef";
                 for (var i = 0; i < 36; i++) {
                     s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
                 }
                 s[14] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
                 s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01
                 s[8] = s[13] = s[18] = s[23] = "-";

                 var uuid = s.join("");
                 return uuid;
             }

             let attributearr = [];//最后生成的主属性
              var obj= {};//
            //点击添加主属性组
             $('.add').on('click',function(){
                  var num =1;

                 num++;

                 //console.log(obj)
                 var arr = new Array();//存储融合的主属性
                 var arr1 = new Array();//存放主属性来源信息
                 // console.log(arr)
                 $('.user-oper').css('display','block');
                 $(".user-oper").on('click',function(event){
                     var $this = $(this);
                      // event.stopPropagation();
                      var isclass = $this.hasClass('layui-form-checked');
                      //console.log(isclass)
                     var text = $this.parents('.tablelist').find('h2').text();
                     var id = $this.parents('.tablelist').find('p').text();
                     var index = text.indexOf(":");
                     var name = text.substring(index+1); //表名

                     var attr = $this.parent().next().text();//某个具体属性
                     var i =attr.indexOf(":")
                     var type = attr.substring(0,i);
                     var str= '' + id + ':'+ type ;
                     var tem = `<p>${type}来源于${name}</p>`;

                     if(!isclass){

                          $this.addClass('layui-form-checked');
                         arr.push(str);
                         arr1.push(tem)


                     }else{

                         $this.removeClass('layui-form-checked');

                         if(arr.indexOf(str) != -1){
                               arr.splice(arr.indexOf(str),1);
                         }
                         if(arr1.indexOf(tem) != -1){
                             arr1.splice(arr1.indexOf(tem),1);
                         }

                     }
                     $('.results').html(arr1);

                 })

                 $('.create-confim').on('click',function (event) {
                     var obj = Object.create(null);
                     //console.log(arr);
                     var key =$('#nature_name').val();//用户输入的主属性名

                    var judge = $('#selectbox option:selected').val();//判断相似符
                      if(arr.length==0){
                          layer.alert('请选择需要融合的数据')
                      }else if(arr.length>0){
                          if(key == ''){
                              layer.alert('请输入准备生成的主属性名称')
                          }else{
                              obj.id = uuid();
                              obj.params = arr;
                              obj.paramsName = key;
                              obj.operator= judge;


                          }
                         // console.log(obj)
                          maindata.push(obj);
                          obj = null;
                          layer.alert('主属性组件创建成功')
                          //console.log(maindata);
                          constraint(maindata);
                          //showtable(tablearr);
                          viewnature(maindata);
                      }
                       arr=[];//清空选定融合的属性
                      arr1 =[];//清空来源信息提醒
                     $('.results').empty();
                     $(".user-oper").removeClass('layui-form-checked');

                 })
             })

                 let currentId = '';//生成约束条件带点击添加的表格id(uuid);
               let allnature =[];//生成的所有主属性数据
              let conditionId = '';//传给后台的约束条件
             //生成主约束条件
             function constraint(data){
                   //console.log(data)
                 var newdata = data;
                 allnature = data;
                var val = newdata.map(item=>{
                    return `<li class="everyitem" data-name="${item.paramsName}" style="height:80px;border: 1px solid #ddd;text-align: left;padding: 10px;margin:10px;clear:both;"><p>主属性名:${item.paramsName}</p><p>融合的数据:${item.params}</p><p>相似判断符:${item.operator}</p></li>`

              })
                    //console.log(val);
                 $('#picList2').html(val);

                 $(".picScroll-left").slide({titCell:".hd ul",mainCell:".bd ul",autoPage:true,effect:"top",autoPlay:false,vis:3,trigger:"click"});
                 $('.everyitem').on('click',function(){

                     //var id = $(this).attr('data-id');
                     var name = $(this).attr('data-name');

                     insertText(document.getElementById('text'),name);
                     //currentId = id;
                 })
             }

             //在光标位置插入文字
             function insertText(obj, str) {

                 obj.focus();
                 if (document.selection) {
                     var sel = document.selection.createRange();
                     sel.text = str;
                 } else if (typeof obj.selectionStart == 'number'
                     && typeof obj.selectionEnd == 'number') {
                     var startPos = obj.selectionStart, endPos = obj.selectionEnd, cursorPos = startPos, tmpStr = obj.value;
                     obj.value = tmpStr.substring(0, startPos) + str
                         + tmpStr.substring(endPos, tmpStr.length);
                     cursorPos += str.length;
                     obj.selectionStart = obj.selectionEnd = cursorPos;
                 } else {
                     obj.value += str;
                 }
             }

             function moveEnd(obj) {

                 obj.focus();
                 var len = obj.value.length;
                 if (document.selection) {
                     var sel = obj.createTextRange();
                     sel.moveStart('character', len);
                     sel.collapse();
                     sel.select();
                 } else if (typeof obj.selectionStart == 'number'
                     && typeof obj.selectionEnd == 'number') {
                     obj.selectionStart = obj.selectionEnd = len;
                 }
                 var text= document.getElementById('text').value;
                 viewconstraint(text);
                 //console.log(allnature);
                 //console.log(text);
                 conditionId= text;
                 // console.log(conditionId)
                 let strings = text.replace("(","").replace(")","")
                     .replace("AND")
                     .replace("OR")
                     .replace("NOT")
                     .split(" ");


                // console.log(strings);
                 let clearParamsArr = [];
                 for(let i = 0; i <strings.length;  i ++ ){
                     if( !(strings[i] === "" || strings[i] === "undefined")){
                         clearParamsArr.push(strings[i]);
                     }
                 }
                 for(let i = 0; i <clearParamsArr.length;i ++ ){
                     for(let j = 0; j <allnature.length;j ++ ){
                         if (clearParamsArr[i] === (allnature[j].paramsName)) {

                             conditionId = conditionId.replace(clearParamsArr[i],allnature[j].id)

                         }
                     }
                 }
                 layer.alert('约束条件:['+ text + ']生成')
                 // console.log(conditionId)
                 // console.log(tablearr);
                 // console.log(allnature);
                 $('.user-oper').css('display','none').removeClass('layui-form-checked');
             }

             $('.foot-confim span').on('click',function(){
                 moveEnd(document.getElementById('text'));
             })
             $('#operator li').on('click',function(){
                    var text = $(this).text();
                    // console.log(text);
                 insertText(document.getElementById('text'),text);
             })
             //选择存储位置
             $('#browse').on('click', function(){
                 layer.open({
                     type: 2,
                     // area: ['550px', '300px'],
                     area: ['750px', '550px'],
                     title:'neo4j选择目录',
                     fixed: false, //不固定
                     maxmin: true,
                     // content: 'dataAddBrowse/replaceOrSkip.html'
                     content: '../dataAddBrowse/browse.html'
                 });
             });

              function showtable(data){
                  //console.log(data);
                  var val = data.map(item=>{
                      var id = item.realTableName;
                      var name = item.tableName;
                      var data = item.columns;
                      data = data.map(list=>{
                          return `<div style="line-height: 30px;margin: 5px 0;margin-left: 20px;display: flex;" class="every">

                                 <div class="layui-table-cell laytable-cell-1-0-0 laytable-cell-checkbox" style="text-align:left;padding-left: 20px;"><input type="checkbox" name="layTableCheckbox" lay-skin="primary" style="display: none"><div class="layui-unselect layui-form-checkbox user-oper" lay-skin="primary" style="margin-right: 10px;margin-top: 7px;"><i class="layui-icon layui-icon-ok"></i></div></div>
                                 <span class="tablename">${list.columnName}:${list.columnType}</span>
                              </div>`
                      })

                      return `<li class="tablelist" style="overflow-y: auto;">
                                <h2 style="text-align: center;line-height: 30px;margin: 10px 0;">${name}:${id}</h2><p style="display: none;">${id}</p>` + data.join('') + `</li>`
                  })

                  $('#picList3').html(val);

                  $(".picScroll-left").slide({titCell:".hd ul",mainCell:".bd ul",autoPage:true,effect:"left",autoPlay:false,vis:3,trigger:"click"});
              }

         let column =[];//需要选的来源数据



         function isexist(){

               // 添加主参考start
             $('#addconsults').on('click',function(){
                 layer.alert('请先选择数据再选择插入位置');
                 let major = '';//主要信息
                 $('.user-oper').css('display','none');
                 $('.tablename').on('click',function(){
                     var $this = $(this);

                     var attr = $this.text();//某个具体属性
                     var i =attr.indexOf(":")
                     var type = attr.substring(0,i);
                     var text = $this.parents('.tablelist').find('p').text();
                     var index = text.indexOf(":");
                     var name = text.substring(index+1); //表名

                     major = ''+ name + ":" + type;
                     currentmajor(major);
                 })

                 function currentmajor(str){
                     // console.log(str)
                     $('.mains').on('click',function() {
                         $(this).text(str);
                     })
                 }

              })
             // 添加主参考end
             //添加选择start
              $('#addchooses').on('click',function(){
                  layer.alert('请先选择数据再选择插入位置');
                  let column=[];
                  $('#picList3 .user-oper').removeClass('layui-form-checked');
                  $('#picList3 .user-oper').css('display','block');
                  $('#picList3 .user-oper').on('click',function(){
                      var $this = $(this);

                      var isclass = $this.hasClass('layui-form-checked');
                      var text = $this.parents('.tablelist').find('p').text();
                      var index = text.indexOf(":");
                      var name = text.substring(index+1); //表名

                      var attr = $this.parent().next().text();//某个具体属性
                      var i =attr.indexOf(":")
                      var type = attr.substring(0,i);
                      var str= '' + name + ':'+ type ;
                      //console.log(isclass);
                      if(isclass){
                          $this.addClass("layui-form-checked");
                          column.push(str);

                      }else{
                          $this.removeClass('layui-form-checked');
                          if(column.indexOf(str) != -1){
                              column.splice(column.indexOf(str),1);
                          }
                      }
                      // console.log('--------');
                      // console.log(column);
                      $('.chooses').on('click',function(){
                            $(this).text(column);
                      })


               })
                  column = [];
              })

              }








               let columndata = [];//
            let tabledetaildata ;

         $("#submitTableInfoBtn").click(function () {
             var $uls = $(".table-list").children(".list");
             var name = $('#table_name').val();
             var local =$('#parentId').val();
              var nodeId = $('#parentId').val();
             //  $.ajax({
             //      type:'get',
             //      data:'',
             //      url:'/dataMapping/getDataMappingTableNamesByPid?parent_id' + nodeId,
             //      async:false,
             //      dataType: 'json',
             //      contentType: 'text/plain;charset=UTF-8',
             //      success:function(res){
             //          console.log(res)
             //      },
             //      error:function(data){
             //          layer.alert(data.msg);
             // }
             //  })
             var columns = [];
             for(let i = 0 ; i < $uls.length ; i++){
                 let currntLine = $($uls[i]);
                 let t_name = currntLine.find(".names").find("input").val();
                 let t_type = currntLine.find(".types").find("input").val();
                 let t_length = currntLine.find(".lengths").find("input").val();
                 let t_extarea = currntLine.find(".extarea").find("input").val();
                 let t_results = currntLine.find('.chooses').text();
                 let t_main = currntLine.find('.mains').text();
                 // console.log(t_results)
                 t_results = t_results.split(',');
                 let columnInfo = {
                     "name":t_name,
                     "type":t_type,
                     "length":t_length,
                     "remark":t_extarea,
                     "sourceField":t_results,
                     "major":t_main
                 };
                 columns.push(columnInfo);

             }
             // console.log(name)
             // console.log(columns)
             let tableinfo ={
                 tableName:name,
                 localStorage:local,
                 columns:columns
             }
             // console.log(tableinfo);
             showtableinfo(tableinfo);
             tabledetaildata = tableinfo;
             layer.alert('存储数据成功')
         });


              $('.del span').on('click',function(){
                  $(this).parents('.list').remove();
              })


             $('#addtabellist').on('click',function(){

                  let tem =`<ul class="list">
                                   <li class="names"><input type="text" ></li>
                                   <li class="types"><input type="text"></li>
                                   <li class="lengths"><input type="text"></li>
                                   <li class="extarea"><input type="text"></li>
                                   <li class="chooses"></li>
                                   <li class="mains"></li>
                                   <!--<li style="display:flex;justify-content: center;align-content: center;"><span>删除</span></li>-->
                                  </ul>`
                   $('.table-list').append(tem);
                 isexist();
             })



            function viewnature(data){

                //console.log( allnature);
                var val = allnature.map(item=>{
                    return `<li class="everyitem" data-name="${item.paramsName}" style="height:80px;border: 1px solid #ddd;text-align: left;padding: 10px;margin:10px;"><p>主属性名:${item.paramsName}</p><p>融合的数据:${item.params}</p><p>相似判断符:${item.operator}</p></li>`

                })
                //console.log(val);
                $('#picList4').html(val);

                $(".picScroll-left").slide({titCell:".hd ul",mainCell:".bd ul",autoPage:true,effect:"top",autoPlay:false,vis:3,trigger:"click"});
            }
            function viewconstraint(val){
                 var str = val;
                 // console.log(str);
                $('.view-content').html(str);
            }
            function showtableinfo(obj){
                  // console.log(obj);
                   let arr = obj.columns;
                   arr = arr.map(item=>{
                          return '<ul>' +
                                   '<li>'+ item.name + '</li>'+
                                  '<li>' +item.type+ '</li>'+
                                  '<li>'+item.length + '</li>'+
                                  '<li>'+item.remark +'</li>'+
                                  '<li>'+ item.sourceField +'</li>'+
                              '</ul>'
                       })
                  let newtable = ` <div class="table_info">
                    <p class="table-name">表名: ${obj.tableName}</p>
                    <p class="localstore">存储位置: ${obj.localStorage}</p>
                    <ul>
                        <li>名字</li>
                        <li>类型</li>
                        <li>长度</li>
                        <li>备注</li>
                        <li>来源数据字段</li>
                    </ul>`
                      + arr.join('')+
                `</div>`
                $('#tabledetail').html(newtable)
               //console.log(newtable);

            }
            $('#submit').on('click',function(){
                // console.log(conditionId)
                // console.log(tablearr);
                // console.log(allnature);
                // console.log(tabledetaildata);
                let obj ={
                    tables:tablearr,
                    params:allnature,
                    expr:{
                        value:conditionId
                    },
                    fusionTableInfo:tabledetaildata
                }
                 // console.log(obj)
                $.ajax({
                    type:'post',
                    async:true,
                    data:JSON.stringify(obj),
                    dataType: 'json',
                    contentType: 'application/json',
                    url:'/dataFusion/startFusion',
                    success:function(res){
                        //console.log(res)
                        if(res.code == 200){
                            var msg = res.data;
                            layer.alert(msg);
                        }else{
                            var msg = res.errMsg;
                            layer.alert(msg);
                        }

                    },
                    error:function(data){
                        var msg = data.errMsg;
                        console.log(data)
                        layer.alert(msg, {icon: 2})

                    }
                })
            })

         // });
     </script>
</body>
</html>